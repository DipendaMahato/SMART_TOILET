
{
  "entities": {
    "UserProfile": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserProfile",
      "type": "object",
      "description": "Represents a user's profile with personal and medical information.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user profile."
        },
        "firstName": {
          "type": "string",
          "description": "User's first name."
        },
        "lastName": {
          "type": "string",
          "description": "User's last name."
        },
        "email": {
          "type": "string",
          "description": "User's email address.",
          "format": "email"
        },
        "phoneNumber": {
          "type": "string",
          "description": "User's phone number."
        },
        "gender": {
          "type": "string",
          "description": "User's gender."
        },
        "bloodGroup": {
          "type": "string",
          "description": "User's blood group."
        },
        "height": {
          "type": "number",
          "description": "User's height in centimeters."
        },
        "weight": {
          "type": "number",
          "description": "User's weight in kilograms."
        },
        "dateOfBirth": {
          "type": "string",
          "description": "User's date of birth.",
          "format": "date-time"
        },
        "preferences": {
          "type": "object",
          "description": "User-specific application preferences.",
          "properties": {
            "theme": {
              "type": "string",
              "enum": [
                "light",
                "dark",
                "system"
              ]
            },
            "language": {
              "type": "string",
              "enum": [
                "en",
                "hi"
              ]
            },
            "units": {
              "type": "string",
              "enum": [
                "metric",
                "imperial"
              ]
            },
            "biometric": {
              "type": "boolean"
            },
            "appLock": {
              "type": "boolean"
            },
            "emergencyAlerts": {
              "type": "boolean"
            },
            "insightAlerts": {
              "type": "boolean"
            },
            "weeklySummary": {
              "type": "boolean"
            },
            "wifiSync": {
              "type": "boolean"
            },
            "bluetoothSync": {
              "type": "boolean"
            },
            "aiSensitivity": {
              "type": "string",
              "enum": [
                "low",
                "balanced",
                "high"
              ]
            }
          }
        }
      },
      "required": [
        "id",
        "firstName",
        "lastName",
        "email",
        "phoneNumber",
        "gender",
        "bloodGroup",
        "height",
        "weight",
        "dateOfBirth"
      ]
    },
    "HealthData": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "HealthData",
      "type": "object",
      "description": "Represents health data collected from the smart toilet sensors.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the health data entry."
        },
        "userId": {
          "type": "string",
          "description": "Reference to UserProfile. (Relationship: UserProfile 1:N HealthData)"
        },
        "timestamp": {
          "type": "string",
          "description": "Timestamp of when the data was collected.",
          "format": "date-time"
        },
        "urinePH": {
          "type": "number",
          "description": "Urine pH level."
        },
        "urineSpecificGravity": {
          "type": "number",
          "description": "Urine specific gravity."
        },
        "urineProtein": {
          "type": "number",
          "description": "Urine protein level."
        },
        "urineGlucose": {
          "type": "number",
          "description": "Urine glucose level."
        },
        "stoolConsistency": {
          "type": "string",
          "description": "Stool consistency description."
        },
        "stoolColor": {
          "type": "string",
          "description": "Stool color description."
        },
        "isOccupied": {
          "type": "boolean",
          "description": "Indicates if the toilet is currently occupied."
        },
        "leakageDetected": {
          "type": "boolean",
          "description": "Indicates if a water leak is detected."
        },
        "waterFlowRate": {
          "type": "number",
          "description": "Current water flow rate in L/min."
        },
        "flushCount": {
          "type": "number",
          "description": "Number of flushes in a given period."
        },
        "ammoniaLevel": {
          "type": "number",
          "description": "Ammonia gas level in ppm."
        },
        "turbidity": {
          "type": "number",
          "description": "Water turbidity level in NTU."
        },
        "batteryLevel": {
          "type": "number",
          "description": "Device battery level in percent."
        },
        "isOnline": {
          "type": "boolean",
          "description": "Indicates if the device is connected to the internet."
        },
        "signalStrength": {
            "type": "number",
            "description": "Device network signal strength in percent."
        },
        "specificGravity": {
          "type": "number",
          "description": "Urine specific gravity."
        },
        "bloodDetected": {
          "type": "boolean",
          "description": "Indicates if blood is detected in urine."
        },
        "temperature": {
          "type": "number",
          "description": "Ambient temperature in Celsius."
        },
        "humidity": {
          "type": "number",
          "description": "Ambient humidity in percent."
        }
      },
      "required": [
        "id",
        "userId",
        "timestamp",
        "urinePH",
        "urineSpecificGravity",
        "urineProtein",
        "urineGlucose",
        "stoolConsistency",
        "stoolColor"
      ]
    },
    "HealthInsight": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "HealthInsight",
      "type": "object",
      "description": "Represents health insights generated by the AI analysis.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the health insight."
        },
        "userId": {
          "type": "string",
          "description": "Reference to UserProfile. (Relationship: UserProfile 1:N HealthInsight)"
        },
        "timestamp": {
          "type": "string",
          "description": "Timestamp of when the insight was generated.",
          "format": "date-time"
        },
        "insightText": {
          "type": "string",
          "description": "The generated health insight text."
        },
        "reasoning": {
          "type": "string",
          "description": "The reasoning behind the generated insight."
        },
        "recommendation": {
          "type": "string",
          "description": "A recommendation based on the generated health insight."
        }
      },
      "required": [
        "id",
        "userId",
        "timestamp",
        "insightText",
        "reasoning",
        "recommendation"
      ]
    },
    "Notification": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Notification",
      "type": "object",
      "description": "Represents an alert or warning notification for a user.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the notification."
        },
        "userId": {
          "type": "string",
          "description": "Reference to UserProfile. (Relationship: UserProfile 1:N Notification)"
        },
        "timestamp": {
          "type": "string",
          "description": "Timestamp of when the notification was generated.",
          "format": "date-time"
        },
        "message": {
          "type": "string",
          "description": "The main notification text."
        },
        "type": {
          "type": "string",
          "description": "The type of notification (e.g., 'Warning', 'Alert').",
          "enum": [
            "Warning",
            "Alert"
          ]
        },
        "sensorName": {
          "type": "string",
          "description": "The name of the sensor that triggered the notification."
        },
        "currentValue": {
          "type": "string",
          "description": "The value of the sensor at the time of the alert."
        },
        "normalRange": {
          "type": "string",
          "description": "The normal range for the sensor."
        },
        "isRead": {
          "type": "boolean",
          "description": "Indicates if the notification has been read by the user."
        }
      },
      "required": [
        "id",
        "userId",
        "timestamp",
        "message",
        "type",
        "isRead"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "UserProfile",
          "schema": {
            "$ref": "#/backend/entities/UserProfile"
          },
          "description": "Stores user profiles. Path-based ownership enforced via `userId` parameter.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user. Enforces ownership."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/healthData/{healthDataId}",
        "definition": {
          "entityName": "HealthData",
          "schema": {
            "$ref": "#/backend/entities/HealthData"
          },
          "description": "Stores health data for each user. Path-based ownership enforced via `userId` parameter.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user. Enforces ownership."
            },
            {
              "name": "healthDataId",
              "description": "The unique identifier for the health data entry."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/healthInsights/{healthInsightId}",
        "definition": {
          "entityName": "HealthInsight",
          "schema": {
            "$ref": "#/backend/entities/HealthInsight"
          },
          "description": "Stores health insights for each user. Path-based ownership enforced via `userId` parameter.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user. Enforces ownership."
            },
            {
              "name": "healthInsightId",
              "description": "The unique identifier for the health insight."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/notifications/{notificationId}",
        "definition": {
          "entityName": "Notification",
          "schema": {
            "$ref": "#/backend/entities/Notification"
          },
          "description": "Stores user-specific notifications and alerts generated from sensor data.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user. Enforces ownership."
            },
            {
              "name": "notificationId",
              "description": "The unique identifier for the notification."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to ensure data security, scalability, and maintainability, adhering to the principles of Authorization Independence, Clarity of Intent, DBAC, and QAPs. The design uses path-based ownership for user-specific data and prioritizes denormalization to avoid complex security rules that rely on `get()` calls.\n\n**Authorization Independence:**\nPath-based ownership (`/users/{userId}/...`) naturally provides Authorization Independence for `UserProfile`, `HealthData`, and `HealthInsight` entities. Access control can be implemented directly on the path without needing to retrieve data from other documents.\n\n**Structural Segregation:**\nEach top-level collection or subcollection stores only one type of entity. This approach ensures that all documents within the same collection share the same security posture.\n\n**Access Modeling:**\n*   **Private User Data:** The `/users/{userId}` collection structure is used to store user profiles and related data, such as health data and insights. This clearly establishes ownership and simplifies security rules.\n*   The `healthData` and `healthInsights` subcollections under each user document establish clear ownership for this data.\n\n**QAPs Support:**\nThe path-based structure enables simple and secure `list` operations. Listing documents under `/users/{userId}/healthData` is secure because only the authenticated user (`request.auth.uid == userId`) can access this data.\n\n**Example Security Rules:**\n\n```\nmatch /users/{userId} {\n  allow read, update, delete: if request.auth.uid == userId;\n  allow create: if request.auth.uid != null;\n\n  match /healthData/{healthDataId} {\n    allow read, create, update, delete: if request.auth.uid == userId;\n  }\n\n  match /healthInsights/{healthInsightId} {\n    allow read, create, update, delete: if request.auth.uid == userId;\n  }\n}\n```"
  }
}
